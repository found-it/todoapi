####
#
# Azure Pipeline for Todo API Server
#
# Displays usage of the Anchore integration with Azure DevOps
#
#####

trigger:
- master
- dev

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  - name: acrProdServiceConnection
    value: demoProduction
  - name: prodRegistry
    value: 'anchoredemo.azurecr.io'

  - name: acrStagingServiceConnection
    value: demoStaging
  - name: stagingRegistry
    value: 'demostaging.azurecr.io'

  - name: imageRepository
    value: 'todoapi'
  - name: dockerfilePath
    value: 'Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'
  - name: prodImage
    value: '$(prodRegistry)/$(imageRepository)'

  # Agent VM image name
  - name: vmImageName
    value: 'ubuntu-latest'

  # Anchore stuff
  - name: anchoreUser
    value: 'admin'
  - name: anchoreUrl
    value: 'http://23.100.36.77/v1/'
  - group: AnchoreCredentials
    # anchorepass ^

###########################################################

stages:

#
# Stage 1 - Staging
#
- stage: Staging
  displayName: Build and push to staging registry
  jobs:
  - job: Staging
    displayName: Staging
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(acrStagingServiceConnection)
        tags: |
          $(tag)

#
# Stage 2 - Scanning
#
- stage: Scan
  displayName: Scan the staged image
  dependsOn: Staging
  jobs:
  - job: Scan
    displayName: Scan
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AnchoreEnterprise@0
      inputs:
        image: '$(stagingRegistry)/$(imageRepository):$(tag)'
        url: $(anchoreUrl)
        username: $(anchoreUser)
        password: $(anchorepass)
        dockerfile: Dockerfile

#
# Stage 3 - Production
#
- stage: Production
  displayName: Push to production registry
  dependsOn: Scan
  jobs:
  - job: Production
    displayName: Production
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(acrProdServiceConnection)
        tags: |
          $(tag)
